name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'
  AWS_REGION: us-east-1

jobs:
  # Linting Job
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Run Prettier check
        run: npm run format:check
      
      - name: Check TypeScript
        run: npm run type-check

  # Testing Job
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test:ci
      
      # Coverage collection temporarily disabled due to test-exclude Node.js 20 incompatibility
      # See COVERAGE_DISABLED.md for details
      # - name: Generate coverage report
      #   run: npm run test:coverage
      # 
      # - name: Upload coverage reports
      #   uses: actions/upload-artifact@v4
      #   if: always()
      #   with:
      #     name: coverage-reports
      #     path: coverage/
      #     retention-days: 7
      # 
      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v3
      #   with:
      #     files: ./coverage/coverage-final.json
      #     flags: unittests
      #     name: codecov-umbrella

  # Build Job
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_GOOGLE_MAPS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_API_KEY }}
          REACT_APP_OPENAI_API_KEY: ${{ secrets.REACT_APP_OPENAI_API_KEY }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: build/
          retention-days: 7

  # Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit (critical and high severity)
        run: npm audit --audit-level=high
        continue-on-error: false
      
      - name: Run npm audit (moderate severity - report only)
        run: npm audit --audit-level=moderate || true
        continue-on-error: true
      
      - name: Generate npm audit report
        run: npm audit --json > npm-audit-report.json || true
        continue-on-error: true
      
      - name: Upload npm audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 7
      
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --fail-on=high
        continue-on-error: true
        if: env.SNYK_TOKEN != ''
      
      - name: Comment on PR with security findings
        if: github.event_name == 'pull_request' && (failure() || success())
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## Security Scan Results\n\n';
            
            // Check if audit report exists
            if (fs.existsSync('npm-audit-report.json')) {
              const audit = JSON.parse(fs.readFileSync('npm-audit-report.json', 'utf8'));
              const { vulnerabilities } = audit.metadata || {};
              if (vulnerabilities) {
                comment += `### npm audit\n`;
                comment += `- **Critical**: ${vulnerabilities.critical || 0}\n`;
                comment += `- **High**: ${vulnerabilities.high || 0}\n`;
                comment += `- **Moderate**: ${vulnerabilities.moderate || 0}\n`;
                comment += `- **Low**: ${vulnerabilities.low || 0}\n`;
                comment += `- **Info**: ${vulnerabilities.info || 0}\n\n`;
              }
            }
            
            comment += `> Note: High and critical vulnerabilities will fail the pipeline. Moderate and low severity issues are reported but do not block deployment.\n`;
            comment += `> Run \`npm audit\` locally to see details.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Deploy Backend to AWS Amplify Gen 2 (Main branch only)
  deploy-backend:
    name: Deploy Backend to Amplify Gen 2
    runs-on: ubuntu-latest
    needs: [lint, test, build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Install Amplify Backend CLI
        run: npm install -g @aws-amplify/backend-cli
      
      - name: Verify secrets exist in Parameter Store
        run: |
          echo "Verifying required secrets exist in Parameter Store..."
          REQUIRED_SECRETS=("GOOGLE_CLIENT_ID" "GOOGLE_CLIENT_SECRET" "OPENROUTER_API_KEY" "EIA_API_KEY")
          OPTIONAL_SECRETS=("OPENEI_API_KEY")
          
          # Check required secrets
          MISSING_REQUIRED=()
          for secret_name in "${REQUIRED_SECRETS[@]}"; do
            PARAM_PATH="/amplify/d2rn94kbvpfx34/main/${secret_name}"
            if aws ssm get-parameter --name "${PARAM_PATH}" --with-decryption --region us-east-1 > /dev/null 2>&1; then
              echo "✓ ${secret_name} found at ${PARAM_PATH}"
            else
              echo "✗ ${secret_name} NOT found at ${PARAM_PATH}"
              MISSING_REQUIRED+=("${secret_name}")
            fi
          done
          
          # Check optional secrets (warn only)
          for secret_name in "${OPTIONAL_SECRETS[@]}"; do
            PARAM_PATH="/amplify/d2rn94kbvpfx34/main/${secret_name}"
            if aws ssm get-parameter --name "${PARAM_PATH}" --with-decryption --region us-east-1 > /dev/null 2>&1; then
              echo "✓ ${secret_name} found at ${PARAM_PATH}"
            else
              echo "⚠ ${secret_name} not found at ${PARAM_PATH} (optional - handler will work without it)"
              # Create a placeholder value so pipeline-deploy doesn't fail
              echo "Creating placeholder for ${secret_name}..."
              aws ssm put-parameter \
                --name "${PARAM_PATH}" \
                --value "placeholder-not-used" \
                --type "SecureString" \
                --region us-east-1 \
                --overwrite > /dev/null 2>&1 || echo "  Note: Could not create placeholder (may need manual creation)"
            fi
          done
          
          # Fail if required secrets are missing
          if [ ${#MISSING_REQUIRED[@]} -gt 0 ]; then
            echo ""
            echo "ERROR: Missing required secrets:"
            for secret in "${MISSING_REQUIRED[@]}"; do
              echo "  - ${secret}"
              echo "    Create with: aws ssm put-parameter --name /amplify/d2rn94kbvpfx34/main/${secret} --value 'your-value' --type SecureString --region us-east-1"
            done
            exit 1
          fi
          
          echo "All required secrets verified!"
      
      - name: Install Lambda function dependencies
        run: |
          for dir in amplify/function/*/; do
            if [ -f "$dir/package.json" ]; then
              # Check if package.json has dependencies
              if grep -q '"dependencies"' "$dir/package.json" || grep -q '"devDependencies"' "$dir/package.json"; then
                echo "Installing dependencies for $dir"
                cd "$dir"
                if [ -f "package-lock.json" ]; then
                  npm ci
                else
                  echo "No package-lock.json found, running npm install"
                  npm install --production
                fi
                cd - || exit 1
              else
                echo "Skipping $dir (no dependencies)"
              fi
            fi
          done
      
      - name: Deploy backend to Amplify Gen 2
        run: npx ampx pipeline-deploy --branch main --app-id d2rn94kbvpfx34
        # Note: Secrets are now stored in AWS Parameter Store, not GitHub secrets
        # The pipeline-deploy command will automatically read from Parameter Store

  # Deploy Frontend to AWS Amplify Hosting (Main branch only)
  deploy-frontend:
    name: Deploy Frontend to Amplify Hosting
    runs-on: ubuntu-latest
    needs: [lint, test, build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_GOOGLE_MAPS_API_KEY: ${{ secrets.REACT_APP_GOOGLE_MAPS_API_KEY }}
          REACT_APP_OPENAI_API_KEY: ${{ secrets.REACT_APP_OPENAI_API_KEY }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # Note: Frontend deployment to Amplify Hosting requires manual setup
      # For Amplify Gen 2, use the Amplify Console or AWS CLI to deploy
      # Option 1: Use AWS CLI to deploy to S3/CloudFront (if configured)
      # Option 2: Use Amplify Console with GitHub App integration
      # Option 3: Manual deployment via Amplify Console
      - name: Frontend deployment
        run: |
          echo "Frontend build completed. Deploy manually via Amplify Console or configure AWS CLI deployment."
          echo "Build artifacts are in the 'build' directory."
          # Uncomment and configure if using S3/CloudFront:
          # aws s3 sync build/ s3://your-bucket-name --delete
          # aws cloudfront create-invalidation --distribution-id YOUR_DIST_ID --paths "/*"

